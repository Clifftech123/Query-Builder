{
  "query": "WITH CustomerValue AS (SELECT Country, Segment, Product_1, SUM(CAST(GrossSales as DECIMAL(18,2))) as TotalRevenue, SUM(CAST(Profit as DECIMAL(18,2))) as TotalProfit, COUNT(*) as Transactions, AVG(CAST(GrossSales as DECIMAL(18,2))) as AvgTransactionValue, SUM(CAST(UnitsSold as DECIMAL(18,2))) as TotalUnits FROM [Upload_edaa4303640341b48950bb3eb0385f60_20251215203858] GROUP BY Country, Segment, Product_1), ValueSegmentation AS (SELECT Country, Segment, Product_1 as Product, TotalRevenue, TotalProfit, Transactions, AvgTransactionValue, TotalUnits, (TotalProfit / TotalRevenue * 100) as ProfitMargin, CASE WHEN AvgTransactionValue > 300000 THEN 'Platinum' WHEN AvgTransactionValue > 150000 THEN 'Gold' WHEN AvgTransactionValue > 50000 THEN 'Silver' ELSE 'Bronze' END as CustomerTier FROM CustomerValue WHERE Transactions > 1) SELECT CustomerTier, COUNT(DISTINCT Country + Segment + Product) as Segments, SUM(Transactions) as TotalTransactions, CAST(AVG(TotalRevenue) as DECIMAL(18,2)) as AvgRevenue, CAST(SUM(TotalRevenue) as DECIMAL(18,2)) as TotalRevenue, CAST(SUM(TotalProfit) as DECIMAL(18,2)) as TotalProfit, CAST(AVG(ProfitMargin) as DECIMAL(10,2)) as AvgProfitMargin, CAST(AVG(AvgTransactionValue) as DECIMAL(18,2)) as AvgDealSize FROM ValueSegmentation GROUP BY CustomerTier ORDER BY CASE CustomerTier WHEN 'Platinum' THEN 1 WHEN 'Gold' THEN 2 WHEN 'Silver' THEN 3 ELSE 4 END"
}
