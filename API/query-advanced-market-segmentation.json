{
  "query": "WITH ProductSegmentPerformance AS (SELECT Product_1 as Product, Segment, Country, SUM(CAST(GrossSales as DECIMAL(18,2))) as Revenue, SUM(CAST(Profit as DECIMAL(18,2))) as Profit, COUNT(*) as Transactions, AVG(CAST(UnitsSold as DECIMAL(18,2))) as AvgUnits FROM [Upload_edaa4303640341b48950bb3eb0385f60_20251215203858] GROUP BY Product_1, Segment, Country), RankedPerformance AS (SELECT Product, Segment, Country, Revenue, Profit, Transactions, AvgUnits, (Profit / Revenue * 100) as ProfitMargin, ROW_NUMBER() OVER (PARTITION BY Product ORDER BY Revenue DESC) as ProductRank, ROW_NUMBER() OVER (PARTITION BY Segment ORDER BY Profit DESC) as SegmentRank FROM ProductSegmentPerformance WHERE Revenue > 100000) SELECT Product, Segment, Country, CAST(Revenue as DECIMAL(18,2)) as Revenue, CAST(Profit as DECIMAL(18,2)) as Profit, CAST(ProfitMargin as DECIMAL(10,2)) as ProfitMargin, Transactions, CAST(AvgUnits as DECIMAL(18,2)) as AvgUnits, ProductRank, SegmentRank FROM RankedPerformance WHERE ProductRank <= 3 OR SegmentRank <= 3 ORDER BY Product, ProductRank"
}
