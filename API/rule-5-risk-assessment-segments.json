{
  "query": "WITH CountrySegmentRisk AS (SELECT Country, Segment, COUNT(*) as TotalTransactions, SUM(CASE WHEN CAST(Profit as DECIMAL(18,2)) < 0 THEN 1 ELSE 0 END) as LossMakingDeals, SUM(CAST(GrossSales as DECIMAL(18,2))) as TotalRevenue, SUM(CAST(Profit as DECIMAL(18,2))) as NetProfit, AVG(CAST(Discounts as DECIMAL(18,2))) as AvgDiscount FROM [Upload_edaa4303640341b48950bb3eb0385f60_20251215203858] GROUP BY Country, Segment) SELECT Country, Segment, TotalTransactions, LossMakingDeals, CAST((CAST(LossMakingDeals as FLOAT) / CAST(TotalTransactions as FLOAT) * 100) as DECIMAL(10,2)) as LossRatePercent, CAST(TotalRevenue as DECIMAL(18,2)) as Revenue, CAST(NetProfit as DECIMAL(18,2)) as Profit, CAST(AvgDiscount as DECIMAL(18,2)) as AvgDiscount, CASE WHEN (CAST(LossMakingDeals as FLOAT) / CAST(TotalTransactions as FLOAT)) > 0.3 THEN 'High Risk' WHEN (CAST(LossMakingDeals as FLOAT) / CAST(TotalTransactions as FLOAT)) > 0.15 THEN 'Medium Risk' ELSE 'Low Risk' END as RiskLevel FROM CountrySegmentRisk WHERE TotalTransactions >= 10 ORDER BY LossRatePercent DESC, NetProfit ASC"
}
